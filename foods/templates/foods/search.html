{% extends 'base.html' %}
{% load django_bootstrap5 %}
{% load tag_check %}
{% load static %}
{% block content %}
<div class="container">
  {% if field == '1' %}
    <div class="justify-content-center d-flex align-items-center">
      <img class="team_logo me-2" src="{{ team.logo.url }}" style="width: 7rem; height: 7rem;" alt="">
      <div class="d-flex flex-column mt-3">
        <a class="text-decoration-none text-black" href="{% url 'foods:home' team.pk %}">
            <h1 class="fw-bold" style="font-size:2.5rem;">{{ team.name }}<h1>
        </a>
        <p class="" style="color:gray; font-size:1.2rem;">"{{ searched }}" ë§¤ì  ì •ë³´ğŸ•</p>
      </div>
    </div>
    <div class="symbol mb-3">
      <div id="map" style="width:100%;height:400px;"></div>
    </div>
    <div class="container text-center py-3" style="border-top: 0.5rem solid {{ team.color }}; border-bottom: 0.5rem solid {{ team.color }}">
    <div class="row g-4 d-flex justify-content-around p-3">
      {% if result %}
        {% for r in result %}
          <div class="col-8 col-sm-7 col-md-5 col-lg-3 col-xl-3 mx-0  d-flex justify-content-center p-1">
            <div class="border border-1 bg-white p-0 position-relative train-card">
              <a href="{% url 'foods:store_detail' team.pk r.pk %}">
                {% for image in r.store_image.all %}
                  {% if forloop.counter == 1 %}
                    <img src="{{ image.image.url }}" class="card-img-top" alt="...">
                  {% endif %}
                {% endfor %}
              </a>
              <div class="card-body py-2 border-top mb-5">
                <h5 class="card-title text-center my-3">{{ r.name }}</h5>
                <p class="card-text small mx-3">
                {{ r.items }}
                </p>
              </div>
              <div class="position-absolute bottom-0 start-50 translate-middle-x w-100 pb-2">
                <p class="small m-0 text-center">{{ r.team.stadium.name}}</p>
                <p class="small m-0 text-center">
                  {% if r.cnt_followings %}
                  <span class='small m-0'>íŒ”ë¡œìš° {{ r.cnt_followings }}</span>
                  {% else %}
                  <span class='small m-0'>íŒ”ë¡œìš°ê°€ ì—†ìŠµë‹ˆë‹¤</span>
                  {% endif %}
                </p>
                <p class="small m-0 text-center">
                  {% if r.store_reviews.all.count == 0 %}
                    <span class='small m-0'>í‰ê°€ê°€ ì—†ìŠµë‹ˆë‹¤</span>
                  {% else %}
                  {% for i in ""|ljust:r.avg_grade %}
                    <span>â­</span>
                  {% endfor %}
                    <span>{{ r.avg_grade }}({{ r.cnt_reviews }}ëª… í‰ê°€)</span>
                  {% endif %}
                  </p>
              </div>
            </div>
          </div>
        {% endfor %}
        {% else %}
        <h3 class="">"{{ searched }}" ê²€ìƒ‰ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</h3>
      {% endif %}
      </div>
    </div>
  {% elif field == '2' %}
  <div class="justify-content-center d-flex align-items-center">
    <img class="team_logo me-2" src="{{ team.logo.url }}" style="width: 7rem; height: 7rem;" alt="">
    <div class="d-flex flex-column mt-3">
      <a class="text-decoration-none text-black" href="{% url 'foods:home' team.pk %}">
          <h1 class="fw-bold" style="font-size:2.5rem;">{{ team.name }}<h1>
      </a>
      <p class="" style="color:gray; font-size:1.2rem;">"{{ searched }}" ì£¼ë³€ ë§›ì§‘ ì •ë³´ğŸ•</p>
    </div>
  </div>
  <div class="symbol mb-3">
    <div id="map" style="width:100%;height:400px;"></div>
  </div>
  <div class="container text-center py-3" style="border-top: 0.5rem solid {{ team.color }}; border-bottom: 0.5rem solid {{ team.color }}">
  <div class="row g-4 d-flex justify-content-around p-3">
    {% if result %}
      {% for r in result %}
        <div class="col-8 col-sm-7 col-md-5 col-lg-3 col-xl-3 mx-0  d-flex justify-content-center p-1">
          <div class="border border-1 bg-white p-0 position-relative train-card">
            <a href="{% url 'foods:restaurant_detail' team.pk r.pk %}">
              {% for image in r.restaurant_image.all %}
                {% if forloop.counter == 1 %}
                  <img src="{{ image.image.url }}" class="card-img-top" alt="...">
                {% endif %}
              {% endfor %}
            </a>
            <div class="card-body py-2 border-top mb-5">
              <h5 class="card-title text-center my-3">{{ r.name }}</h5>
              <p class="card-text small mx-3">
              {{ r.address }}
              </p>
            </div>
            <div class="position-absolute bottom-0 start-50 translate-middle-x w-100 pb-2">
              <p class="small m-0 text-center">{{ r.team.stadium.name}}</p>
              <p class="small m-0 text-center">
                {% if r.cnt_followings %}
                <span class='small m-0'>íŒ”ë¡œìš° {{ r.cnt_followings }}</span>
                {% else %}
                <span class='small m-0'>íŒ”ë¡œìš°ê°€ ì—†ìŠµë‹ˆë‹¤</span>
                {% endif %}
              </p>
              <p class="small m-0 text-center">
                {% if r.restaurant_reviews.all.count == 0 %}
                  <span class='small m-0'>í‰ê°€ê°€ ì—†ìŠµë‹ˆë‹¤</span>
                {% else %}
                {% for i in ""|ljust:r.avg_grade %}
                  <span>â­</span>
                {% endfor %}
                  <span>{{ r.avg_grade }}({{ r.cnt_reviews }}ëª… í‰ê°€)</span>
                {% endif %}
                </p>
            </div>
          </div>
        </div>
      {% endfor %}
      {% else %}
      <h3 class="">"{{ searched }}" ê²€ìƒ‰ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</h3>
    {% endif %}
    </div>
  </div>
  {% endif %}
</div>

{% block script %}
<script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=6bd32552e80c3bdb46ce44eb2fd8bdcc&libraries=services"></script>
<script>
  var mapContainer = document.getElementById('map'), // ì§€ë„ë¥¼ í‘œì‹œí•  div  
  mapOption = { 
      center: new kakao.maps.LatLng({{ stadium.lat }}, {{ stadium.lon }}), // ì§€ë„ì˜ ì¤‘ì‹¬ì¢Œí‘œ
      level: 2 // ì§€ë„ì˜ í™•ëŒ€ ë ˆë²¨
  };

var map = new kakao.maps.Map(mapContainer, mapOption); // ì§€ë„ë¥¼ ìƒì„±í•©ë‹ˆë‹¤

var new_dicts = {};
var positions = [];

// ë§ˆì»¤ë¥¼ í‘œì‹œí•  ìœ„ì¹˜ì™€ title ê°ì²´ ë°°ì—´ì…ë‹ˆë‹¤ 
  {% for r in result %}
      var name = "{{ r.name }}";
      console.log({{r.lat}})
      var lat = {{ r.lat }};
      var lon = {{ r.lon }};
      new_dicts['name'] = name;
      new_dicts['latlng'] = new kakao.maps.LatLng(lat,lon)
      positions.push(new_dicts);
      var new_dicts = {};
  {% endfor %}

// ë§ˆì»¤ ì´ë¯¸ì§€ì˜ ì´ë¯¸ì§€ ì£¼ì†Œì…ë‹ˆë‹¤
var imageSrc = "https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/markerStar.png"; 
  
for (var i = 0; i < positions.length; i ++) {
  // ë§ˆì»¤ ì´ë¯¸ì§€ì˜ ì´ë¯¸ì§€ í¬ê¸° ì…ë‹ˆë‹¤
  var imageSize = new kakao.maps.Size(24, 35); 
  
  // ë§ˆì»¤ ì´ë¯¸ì§€ë¥¼ ìƒì„±í•©ë‹ˆë‹¤    
  var markerImage = new kakao.maps.MarkerImage(imageSrc, imageSize); 
  
  // ë§ˆì»¤ë¥¼ ìƒì„±í•©ë‹ˆë‹¤
  var marker = new kakao.maps.Marker({
      map: map, // ë§ˆì»¤ë¥¼ í‘œì‹œí•  ì§€ë„
      position: positions[i].latlng, // ë§ˆì»¤ë¥¼ í‘œì‹œí•  ìœ„ì¹˜
      title : positions[i].name, // ë§ˆì»¤ì˜ íƒ€ì´í‹€, ë§ˆì»¤ì— ë§ˆìš°ìŠ¤ë¥¼ ì˜¬ë¦¬ë©´ íƒ€ì´í‹€ì´ í‘œì‹œë©ë‹ˆë‹¤
      image : markerImage // ë§ˆì»¤ ì´ë¯¸ì§€ 
  });
}

var coords = new kakao.maps.LatLng({{ stadium.lat }}, {{ stadium.lon }});

var marker = new kakao.maps.Marker({
  map: map,
  position: coords
});

var customOverlay = new kakao.maps.CustomOverlay({
  map: map,
  clickable: true,
  content: '<div class="customOverlay">{{ stadium.name }}</div>',
  position: new kakao.maps.LatLng({{ stadium.lat }}, {{ stadium.lon }}),
  xAnchor: 0.5,
  yAnchor: 2,
  
});

customOverlay.setMap(null)
// ë§ˆì»¤ì— ë§ˆìš°ìŠ¤ì˜¤ë²„ ì´ë²¤íŠ¸ë¥¼ ë“±ë¡í•©ë‹ˆë‹¤
kakao.maps.event.addListener(marker, 'mouseover', function() {
  // ë§ˆì»¤ì— ë§ˆìš°ìŠ¤ì˜¤ë²„ ì´ë²¤íŠ¸ê°€ ë°œìƒí•˜ë©´ ì¸í¬ìœˆë„ìš°ë¥¼ ë§ˆì»¤ìœ„ì— í‘œì‹œí•©ë‹ˆë‹¤
  customOverlay.setMap(map)
});

// ë§ˆì»¤ì— ë§ˆìš°ìŠ¤ì•„ì›ƒ ì´ë²¤íŠ¸ë¥¼ ë“±ë¡í•©ë‹ˆë‹¤
kakao.maps.event.addListener(marker, 'mouseout', function() {
  // ë§ˆì»¤ì— ë§ˆìš°ìŠ¤ì•„ì›ƒ ì´ë²¤íŠ¸ê°€ ë°œìƒí•˜ë©´ ì¸í¬ìœˆë„ìš°ë¥¼ ì œê±°í•©ë‹ˆë‹¤
  customOverlay.setMap(null)
});
  {% comment %} var geocoder = new kakao.maps.services.Geocoder();

  geocoder.addressSearch("{{ stadium.address }}", function(result, status) {
  
      // ì •ìƒì ìœ¼ë¡œ ê²€ìƒ‰ì´ ì™„ë£Œëìœ¼ë©´ 
       if (status === kakao.maps.services.Status.OK) {
          var coords = new kakao.maps.LatLng(result[0].y, result[0].x);

          // ê²°ê³¼ê°’ìœ¼ë¡œ ë°›ì€ ìœ„ì¹˜ë¥¼ ë§ˆì»¤ë¡œ í‘œì‹œí•©ë‹ˆë‹¤
          var marker = new kakao.maps.Marker({
              map: map,
              position: coords
          });
  
          // ì¸í¬ìœˆë„ìš°ë¡œ ì¥ì†Œì— ëŒ€í•œ ì„¤ëª…ì„ í‘œì‹œí•©ë‹ˆë‹¤
          var infowindow = new kakao.maps.InfoWindow({
              content: '<div style="width:auto;text-align:center;padding:6px 0;">{{ stadium.name }}</div>'
          });

          infowindow.open(map, marker);
          // ì§€ë„ì˜ ì¤‘ì‹¬ì„ ê²°ê³¼ê°’ìœ¼ë¡œ ë°›ì€ ìœ„ì¹˜ë¡œ ì´ë™ì‹œí‚µë‹ˆë‹¤
          map.setCenter(35.19545081038179,129.06733276110197);
      } 
  var imageSrc = "https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/markerStar.png"; 
  // ì£¼ì†Œë¡œ ì¢Œí‘œë¥¼ ê²€ìƒ‰í•©ë‹ˆë‹¤
  }); {% endcomment %}
</script>
{% endblock script %}
{% endblock %}